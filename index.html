<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Rakan Tracker</title>
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#0b1220">
<style>
:root { color-scheme: dark; }
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
header{position:sticky;top:0;z-index:5;background:#0f172a;border-bottom:1px solid #1f2937;padding:12px 14px}
h1{margin:0;font-size:18px}
main{padding:12px 14px;max-width:1100px;margin:0 auto}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
input,button,select{padding:10px;border-radius:10px;border:1px solid #374151;background:#111827;color:#e5e7eb}
input{flex:1}
button.primary{background:#2563eb;border-color:#2563eb}
.card{background:#0f172a;border:1px solid #1f2937;border-radius:12px;padding:12px;margin:10px 0}
table{width:100%;border-collapse:collapse;min-width:760px}
th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:14px}
td.right{text-align:right}
.badge{padding:2px 6px;border-radius:6px;background:#1f2937;color:#9ca3af;font-size:12px}
.hint{color:#9ca3af;font-size:12px}
.totals{display:flex;gap:12px;flex-wrap:wrap}
.total-pill{background:#111827;border:1px solid #1f2937;border-radius:10px;padding:8px 10px}
.err{color:#fca5a5;white-space:pre-wrap;font-size:12px;margin-top:6px}
.small{font-size:12px;opacity:.8}
footer{padding:16px;text-align:center;color:#9ca3af}
.up{color:#34d399}.down{color:#fca5a5}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<header>
  <h1>Rakan Tracker</h1>
  <div class="row">
    <input id="ticker" placeholder="Ticker (7010.SR, 2222.SR, SPUS)">
    <input id="qty" type="number" step="0.0001" placeholder="Qty">
    <input id="avg" type="number" step="0.0001" placeholder="Avg (listing ccy)">
    <button id="add" class="primary">Add</button>
  </div>
  <div class="row">
    <label class="small"><input id="auto" type="checkbox"> Auto-refresh (5s)</label>
    <button id="refresh" class="primary">Refresh Now</button>
    <span id="fx" class="small"></span>
  </div>
  <div class="hint">Saudi tickers end with <code>.SR</code>. US like <code>SPUS</code> without suffix. Data saved on your device.</div>
</header>

<main>
  <section class="card">
    <div style="overflow:auto;">
      <table id="tab">
        <thead>
          <tr>
            <th>Ticker</th><th>Name</th><th>Ccy</th><th>Qty</th><th>Avg</th><th>Last</th>
            <th class="right">MV (SAR)</th><th class="right">Cost (SAR)</th><th class="right">P/L</th><th class="right">%P/L</th><th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="row totals">
      <div class="total-pill">Total Cost: <b id="tCost">0</b> SAR</div>
      <div class="total-pill">Total Market: <b id="tMV">0</b> SAR</div>
      <div class="total-pill">P/L: <b id="tPL">0</b> SAR</div>
      <div class="total-pill small" id="status"></div>
    </div>
    <div id="err" class="err"></div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px 0">Portfolio Value Over Time</h3>
    <canvas id="tsChart" height="160"></canvas>
  </section>
</main>

<footer>
  <small>Rakan Tracker • PWA • Dark • Auto 5s</small>
</footer>

<script>
// --- PWA registration ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => navigator.serviceWorker.register('/sw.js'));
}

const LS_KEY = "rakan_pwa_state_v1";
const $ = s => document.querySelector(s);
const state = { items:[], quotes:{}, usdToSar:3.75, timer:null, history:[] };

function load(){
  try{
    const x = JSON.parse(localStorage.getItem(LS_KEY)||"{}");
    if (Array.isArray(x.items)) state.items = x.items;
    if (Array.isArray(x.history)) state.history = x.history;
  }catch{}
}
function save(){
  localStorage.setItem(LS_KEY, JSON.stringify({items:state.items, history:state.history}));
}
function uid(){ return Math.random().toString(36).slice(2)+Date.now().toString(36) }

function render(){
  const tb = $("#tab tbody"); tb.innerHTML="";
  let tCost=0, tMV=0;
  for(const it of state.items){
    const q = state.quotes[it.ticker] || {};
    const price = Number(q.price ?? 0);
    const ccy = (q.ccy || (it.ticker.endsWith(".SR")?"SAR":"USD")).toUpperCase();
    const qty = Number(it.qty||0);
    const avg = Number(it.avg||0);
    const mvBase = (price*qty) * (ccy==="USD"? state.usdToSar:1);
    const costBase = (avg*qty) * (ccy==="USD"? state.usdToSar: (it.ticker.endsWith(".SR")?1: state.usdToSar)); // assume avg in listing ccy
    const pl = mvBase - costBase;
    const plPct = costBase>0? (pl/costBase*100):0;
    tCost += costBase; tMV += mvBase;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${it.ticker}</td>
      <td>${q.name||"-"}</td>
      <td>${ccy}</td>
      <td>${qty.toLocaleString()}</td>
      <td>${avg? avg.toLocaleString(): "-"}</td>
      <td>${price? price.toLocaleString(): "N/A"}</td>
      <td class="right">${mvBase.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td class="right">${costBase.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td class="right ${pl>=0?'up':'down'}">${pl.toLocaleString(undefined,{maximumFractionDigits:2})}</td>
      <td class="right ${plPct>=0?'up':'down'}">${plPct.toFixed(2)}%</td>
      <td><button class="del" data-id="${it.id}">✕</button></td>`;
    tb.appendChild(tr);
  }
  $("#tCost").textContent = tCost.toLocaleString(undefined,{maximumFractionDigits:2});
  $("#tMV").textContent = tMV.toLocaleString(undefined,{maximumFractionDigits:2});
  $("#tPL").textContent = (tMV - tCost).toLocaleString(undefined,{maximumFractionDigits:2});
  updateChart(tMV);
}

let chart;
function updateChart(totalMV){
  const ts = new Date().toLocaleTimeString();
  if (totalMV>0){
    state.history.push({t:ts, v:totalMV});
    if (state.history.length>200) state.history.shift();
    save();
  }
  const labels = state.history.map(x=>x.t);
  const data = state.history.map(x=>x.v);
  const ctx = $("#tsChart").getContext("2d");
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:"line",
    data:{ labels, datasets:[{ label:"Total MV (SAR)", data, tension:0.3 }]},
    options:{ plugins:{legend:{labels:{color:"#e5e7eb"}}}, scales:{ x:{ ticks:{color:"#e5e7eb"}}, y:{ ticks:{color:"#e5e7eb"}} } }
  });
}

// ---- Fetchers (Yahoo direct; fallback autoc + query2 + quoteSummary) ----
async function fetchJSON(url){
  const proxies = [
    (u) => "https://cors.isomorphic-git.org/" + u,
    (u) => "https://corsproxy.io/?" + encodeURIComponent(u),
    (u) => "https://api.allorigins.win/raw?url=" + encodeURIComponent(u), // ثالث احتياط
  ];
  for (const build of proxies){
    try{
      const r = await fetch(build(url));
      if (r.ok) return await r.json();
    }catch(e){}
  }
  throw new Error("Failed via proxies");

async function resolveSymbol(sym){
  try{
    const u = `https://autoc.finance.yahoo.com/autoc?query=${encodeURIComponent(sym)}&region=US&lang=en-US`;
    const d = await fetchJSON(u);
    const cand = (d?.ResultSet?.Result||[]).find(r => (r.symbol||"").toUpperCase()===sym) || (d?.ResultSet?.Result||[])[0];
    return (cand?.symbol || sym).toUpperCase();
  }catch{ return sym; }
}

async function fetchOne(symRaw){
  const sym = await resolveSymbol(symRaw);
  const urls = [
    `https://query1.finance.yahoo.com/v7/finance/quote?lang=en-US&region=US&symbols=${encodeURIComponent(sym)}`,
    `https://query2.finance.yahoo.com/v7/finance/quote?lang=en-US&region=US&symbols=${encodeURIComponent(sym)}`,
    `https://query1.finance.yahoo.com/v10/finance/quoteSummary/${encodeURIComponent(sym)}?modules=price&lang=en-US&region=US`
  ];
  for (const u of urls){
    try{
      const data = await fetchJSON(u);
      const list = data?.quoteResponse?.result;
      if (Array.isArray(list) && list.length){
        const q = list[0];
        const price = q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice ?? null;
        const ccy = (q.currency || (sym.endsWith(".SR")?"SAR":"USD")).toUpperCase();
        const name = q.shortName || q.longName || sym;
        state.quotes[symRaw] = {price, ccy, name};
        return true;
      }
      const p = data?.quoteSummary?.result?.[0]?.price;
      if (p){
        const price = p.regularMarketPrice?.raw ?? p.postMarketPrice?.raw ?? null;
        const ccy = (p.currency || (sym.endsWith(".SR")?"SAR":"USD")).toUpperCase();
        const name = p.shortName || p.longName || sym;
        state.quotes[symRaw] = {price, ccy, name};
        return true;
      }
    }catch(_){}
  }
  return false;
}

async function fetchQuotes(){
  const tickers = [...new Set(state.items.map(i=>i.ticker))];
  state.quotes = {};
  let errs = [];

  if (tickers.length){
    // batch query1
    try{
      const url = `https://query1.finance.yahoo.com/v7/finance/quote?lang=en-US&region=US&symbols=${encodeURIComponent(tickers.join(","))}`;
      const data = await fetchJSON(url);
      const list = data?.quoteResponse?.result || [];
      const returned = new Set();
      for (const q of list){
        const sym = (q.symbol||"").toUpperCase();
        const price = q.regularMarketPrice ?? q.postMarketPrice ?? q.preMarketPrice ?? null;
        const ccy = (q.currency || (sym.endsWith(".SR")?"SAR":"USD")).toUpperCase();
        const name = q.shortName || q.longName || sym;
        // Map back to input ticker if possible
        const match = tickers.find(t=>t===sym) || sym;
        state.quotes[match] = {price, ccy, name};
        returned.add(match);
      }
      for (const t of tickers){
        if (!returned.has(t)){
          const ok = await fetchOne(t);
          if (!ok) errs.push("No quote for "+t);
        }
      }
    }catch(e){
      for (const t of tickers){
        const ok = await fetchOne(t);
        if (!ok) errs.push("No quote for "+t+" — "+(e.message||e));
      }
    }
  }

  // FX USD→SAR
  try{
    const fx = await fetchJSON(`https://query1.finance.yahoo.com/v7/finance/quote?symbols=SAR=X`);
    const p = fx?.quoteResponse?.result?.[0]?.regularMarketPrice;
    if (p && p>0) state.usdToSar = p;
    $("#fx").textContent = "USD→SAR ≈ " + state.usdToSar.toFixed(4);
  }catch{}

  $("#err").textContent = errs.join("\n");
  return errs;
}

// --- UI actions ---
function addItem(){
  const t = $("#ticker").value.trim().toUpperCase();
  const q = Number($("#qty").value||0);
  const a = Number($("#avg").value||0);
  if (!t) { alert("Enter ticker"); return; }
  state.items.push({id:uid(), ticker:t, qty:q, avg:a});
  save();
  $("#ticker").value=""; $("#qty").value=""; $("#avg").value="";
  refresh();
}
function delItem(id){
  state.items = state.items.filter(x=>x.id!==id);
  save(); render();
}
async function refresh(){
  $("#status").textContent = "Updating...";
  await fetchQuotes();
  render();
  $("#status").textContent = "Updated " + new Date().toLocaleTimeString();
}

function toggleAuto(chk){
  if (chk.checked){
    state.timer = setInterval(refresh, 5000);
  } else {
    clearInterval(state.timer); state.timer=null;
  }
}

// --- Init ---
function init(){
  load(); render();
  $("#add").addEventListener("click", addItem);
  $("#refresh").addEventListener("click", refresh);
  $("#auto").addEventListener("change", e=>toggleAuto(e.target));
  $("#tab").addEventListener("click", e=>{
    if (e.target.classList.contains("del")){
      delItem(e.target.getAttribute("data-id"));
    }
  });
  refresh();
}
init();
</script>
</body>
</html>
